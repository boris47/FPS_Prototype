namespace TypeReferences.Editor
{
    using System;
    using System.Collections.Generic;
    using TypeReferences;
    using UnityEditor;
    using UnityEngine;

    /// <summary>
    /// A class that holds static values related to <see cref="TypeReference"/> and its custom inspector.
    /// </summary>
    internal static class CachedTypeReference
    {
        public const string ReferenceUpdatedCommandName = "TypeReferenceUpdated";
        public static readonly int ControlHint = typeof(TypeReferencePropertyDrawer).GetHashCode();
        public static readonly GUIContent FieldContent = new GUIContent();
        public static readonly GenericMenu.MenuFunction2 SelectedTypeName = OnSelectedTypeName;
        public static int SelectionControlID;
        public static string SelectedTypeNameAndAssembly;

        /// <summary>
        /// Improves performance by avoiding a large number of <see cref="M:Type.GetType"/> calls.
        /// </summary>
        private static readonly Dictionary<string, Type> TypeCache = new Dictionary<string, Type>();

        /// <summary>
        /// Get type from TypeCache if it is cached.
        /// Otherwise, find the type, cache it, and return it to the caller.
        /// </summary>
        /// <param name="typeName">Type name, followed by a comma and assembly name.</param>
        /// <returns>Cached class type.</returns>
        public static Type GetType(string typeName)
        {
            if (TypeCache.TryGetValue(typeName, out Type type))
                return type;

            type = ! string.IsNullOrEmpty(typeName) ? Type.GetType(typeName) : null;
            TypeCache[typeName] = type;
            return type;
        }

        private static void OnSelectedTypeName(object userData)
        {
			Type selectedType = userData as Type;

            SelectedTypeNameAndAssembly = TypeReference.GetTypeNameAndAssembly(selectedType);
            Event typeReferenceUpdated = EditorGUIUtility.CommandEvent(ReferenceUpdatedCommandName);
            EditorWindow.focusedWindow.SendEvent(typeReferenceUpdated);
        }
    }
}